<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gerenciar Acertos</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />
</head>

<body>
    <main class="container">
        <h1 class="mb-4">Listar Acertos</h1>

        <table id="tabelaAcertos" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID Acerto</th>
                    <th>Data</th>
                    <th>Motivo</th>
                    <th>Funcionário</th>
                    <th>Produtos Corrigidos</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Linhas de acerto serão inseridas aqui via JS -->
            </tbody>
        </table>
    </main>

    <div id="mensagemToast"></div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            listarAcertosComProdutos();
        });

        function mostrarToast(mensagem, duracao = 3000) {
            let toast = document.getElementById("mensagemToast");
            toast.textContent = mensagem;
            toast.style.display = "block";

            setTimeout(() => {
                toast.style.display = "none";
            }, duracao);
        }

        function apagarAcerto(id) {
            if (!id) {
                alert("ID do acerto não informado.");
                return;
            }

            fetch(`http://localhost:8080/apis/acerto/deletar/${id}`, {
                method: "DELETE",
            })
                .then((response) =>
                    response.json().then((data) => ({ status: response.status, body: data }))
                )
                .then(({ status, body }) => {
                    if (status === 200) {
                        mostrarToast(body.mensagem || "Acerto apagado com sucesso!");
                        listarAcertosComProdutos();
                    } else {
                        mostrarToast(body.mensagem || "Erro ao apagar acerto");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao apagar acerto:", error);
                    mostrarToast("Erro ao apagar acerto");
                });
        }

        async function listarAcertosComProdutos() {
            let tbody = document.querySelector("#tabelaAcertos tbody");
            tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

            try {
                let response = await fetch("http://localhost:8080/apis/acertoestoque/listar-com-produtos");
                if (!response.ok) {
                    tbody.innerHTML = `<tr><td colspan="6">Erro ao buscar acertos: ${response.status}</td></tr>`;
                    return;
                }

                let acertos = await response.json();

                if (!Array.isArray(acertos) || acertos.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='6'>Nenhum acerto encontrado.</td></tr>";
                    return;
                }

                tbody.innerHTML = ""; // limpa antes de preencher

                acertos.forEach(acerto => {
                    let produtosNomes = acerto.produto ? acerto.produto.descricao : "-";
                    let nomeFuncionario = acerto.funcionario ? acerto.funcionario.nome : "Desconhecido";

                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                    <td>${acerto.id}</td>
                    <td>${new Date(acerto.data).toLocaleDateString('pt-BR')}</td>
                    <td>${acerto.motivo}</td>
                    <td>${nomeFuncionario}</td>
                    <td>${produtosNomes}</td>
                    <td class="acoes">
                    <button class="excluir btn btn-danger btn-sm" onclick="apagarAcerto(${acerto.id})">Excluir</button>
                    </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error("Erro ao listar acertos:", error);
                tbody.innerHTML = "<tr><td colspan='6'>Erro ao carregar dados.</td></tr>";
            }
        }
    </script>
</body>

</html>