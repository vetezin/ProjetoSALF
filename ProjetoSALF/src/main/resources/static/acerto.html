<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gerenciar Acertos</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet" />
</head>

<body>

    
  <nav class="navbar navbar-expand-lg custom-navbar fixed-top">
    <div class="container-fluid justify-content-center">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
       <ul class="navbar-nav">
         <li class="nav-item">
           <a class="nav-link " href="index.html">Inicio</a>
         </li>

         <li class="nav-item">
           <a class="nav-link" href="produtos.html">Produtos</a>
         </li>
         <li class="nav-item">
           <a class="nav-link " href="estoque.html">Estoque</a>
         </li>
         <li class="nav-item">
           <a class="nav-link " href="saida.html">Saída</a>
         </li>
         <li class="nav-item">
           <a class="nav-link active" href="acerto.html">Acerto</a>
         </li>
       </ul>
      </div>
    </div>
  </nav>



    <main class="container" style="padding-top: 70px;">
        <h1 class="mb-4">Listar Acertos</h1>

        <div class="d-flex justify-content-end mb-3 gap-2">
       <button class="btn btn-primary" onclick="ordenarPorFuncionarioAcerto()">Ordenar por Funcionário</button>
        <button class="btn btn-primary" onclick="ordenarPorMotivoAcerto()">Ordenar por Motivo</button>
        <button class="btn btn-warning" onclick="window.location.href='regAcerto.html'">Novo Acerto</button>
        </div>


        <table id="tabelaAcertos" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID Acerto</th>
                    <th>Data</th>
                    <th>Motivo</th>
                    <th>Funcionário</th>
                    <th>Produtos Corrigidos</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Linhas de acerto serão inseridas aqui via JS -->
            </tbody>
        </table>
    </main>

    <div id="mensagemToast"></div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            listarAcertosComProdutos();
        });

        function mostrarToast(mensagem, duracao = 3000) {
            let toast = document.getElementById("mensagemToast");
            toast.textContent = mensagem;
            toast.style.display = "block";

            setTimeout(() => {
                toast.style.display = "none";
            }, duracao);
        }

        function apagarAcerto(id) {
            if (!id) {
                alert("ID do acerto não informado.");
                return;
            }

            fetch(`http://localhost:8080/apis/acertoestoque/deletar/${id}`, {
                method: "DELETE",
            })
                .then((response) =>
                    response.json().then((data) => ({ status: response.status, body: data }))
                )
                .then(({ status, body }) => {
                    if (status === 200) {
                        mostrarToast(body.mensagem || "Acerto apagado com sucesso!");
                        listarAcertosComProdutos();
                    } else {
                        mostrarToast(body.mensagem || "Erro ao apagar acerto");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao apagar acerto:", error);
                    mostrarToast("Erro ao apagar acerto");
                });
        }

        async function listarAcertosComProdutos() {
            let tbody = document.querySelector("#tabelaAcertos tbody");
            tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

            try {
                let response = await fetch("http://localhost:8080/apis/acertoestoque/listar-com-produtos");
                if (!response.ok) {
                    tbody.innerHTML = `<tr><td colspan="6">Erro ao buscar acertos: ${response.status}</td></tr>`;
                    return;
                }

                let acertos = await response.json();

                if (!Array.isArray(acertos) || acertos.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='6'>Nenhum acerto encontrado.</td></tr>";
                    return;
                }

                tbody.innerHTML = ""; // limpa antes de preencher

                acertos.forEach(acerto => {
                    let produtosNomes = acerto.produto ? acerto.produto.descricao : "-";
                    let nomeFuncionario = acerto.funcionario ? acerto.funcionario.nome : "Desconhecido";

                    let tr = document.createElement("tr");
                    tr.innerHTML = `
                    <td>${acerto.id}</td>
                    <td>${new Date(acerto.data).toLocaleDateString('pt-BR')}</td>
                    <td>${acerto.motivo}</td>
                    <td>${nomeFuncionario}</td>
                    <td>${produtosNomes}</td>
                    <td class="acoes">
                    <button class="excluir btn btn-danger btn-sm" onclick="apagarAcerto(${acerto.id})">Excluir</button>
                    </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error("Erro ao listar acertos:", error);
                tbody.innerHTML = "<tr><td colspan='6'>Erro ao carregar dados.</td></tr>";
            }
        }

         async function ordenarPorFuncionarioAcerto() {
        let tbody = document.querySelector("#tabelaAcertos tbody");
        tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

        try {
            let response = await fetch("http://localhost:8080/apis/acertoestoque/listar-com-produtos");
            if (!response.ok) {
                tbody.innerHTML = `<tr><td colspan="6">Erro ao buscar acertos: ${response.status}</td></tr>`;
                return;
            }

            let acertos = await response.json();

            if (!Array.isArray(acertos) || acertos.length === 0) {
                tbody.innerHTML = "<tr><td colspan='6'>Nenhum acerto encontrado.</td></tr>";
                return;
            }

            // Ordena pelo nome do funcionário (case insensitive)
            acertos.sort((a, b) => {
                let nomeA = a.funcionario && a.funcionario.nome ? a.funcionario.nome.toLowerCase() : "";
                let nomeB = b.funcionario && b.funcionario.nome ? b.funcionario.nome.toLowerCase() : "";
                if (nomeA < nomeB) return -1;
                if (nomeA > nomeB) return 1;
                return 0;
            });

            tbody.innerHTML = ""; // limpa antes de preencher

            acertos.forEach(acerto => {
                let produtosNomes = acerto.produto ? acerto.produto.descricao : "-";
                let nomeFuncionario = acerto.funcionario ? acerto.funcionario.nome : "Desconhecido";

                let tr = document.createElement("tr");
                tr.innerHTML = `
                <td>${acerto.id}</td>
                <td>${new Date(acerto.data).toLocaleDateString('pt-BR')}</td>
                <td>${acerto.motivo}</td>
                <td>${nomeFuncionario}</td>
                <td>${produtosNomes}</td>
                <td class="acoes">
                <button class="excluir btn btn-danger btn-sm" onclick="apagarAcerto(${acerto.id})">Excluir</button>
                </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (error) {
            console.error("Erro ao ordenar acertos:", error);
            tbody.innerHTML = "<tr><td colspan='6'>Erro ao carregar dados.</td></tr>";
        }
    }

    async function ordenarPorMotivoAcerto() {
    let tbody = document.querySelector("#tabelaAcertos tbody");
    tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

    try {
        let response = await fetch("http://localhost:8080/apis/acertoestoque/listar-com-produtos");
        if (!response.ok) {
            tbody.innerHTML = `<tr><td colspan="6">Erro ao buscar acertos: ${response.status}</td></tr>`;
            return;
        }

        let acertos = await response.json();

        if (!Array.isArray(acertos) || acertos.length === 0) {
            tbody.innerHTML = "<tr><td colspan='6'>Nenhum acerto encontrado.</td></tr>";
            return;
        }

        // Ordena pelo motivo (case insensitive)
        acertos.sort((a, b) => {
            let motivoA = a.motivo ? a.motivo.toLowerCase() : "";
            let motivoB = b.motivo ? b.motivo.toLowerCase() : "";
            if (motivoA < motivoB) return -1;
            if (motivoA > motivoB) return 1;
            return 0;
        });

        tbody.innerHTML = ""; // limpa antes de preencher

        acertos.forEach(acerto => {
            let produtosNomes = acerto.produto ? acerto.produto.descricao : "-";
            let nomeFuncionario = acerto.funcionario ? acerto.funcionario.nome : "Desconhecido";

            let tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${acerto.id}</td>
                <td>${new Date(acerto.data).toLocaleDateString('pt-BR')}</td>
                <td>${acerto.motivo}</td>
                <td>${nomeFuncionario}</td>
                <td>${produtosNomes}</td>
                <td class="acoes">
                    <button class="excluir btn btn-danger btn-sm" onclick="apagarAcerto(${acerto.id})">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

    } catch (error) {
        console.error("Erro ao ordenar acertos:", error);
        tbody.innerHTML = "<tr><td colspan='6'>Erro ao carregar dados.</td></tr>";
    }
    }

    </script>
</body>

</html>