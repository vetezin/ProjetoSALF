<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Fornecedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #393d4c;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header img {
            height: 50px;
            margin-left: 20px;
        }
        header h1 {
            flex-grow: 1;
            text-align: center;
            margin: 0;
            font-size: 24px;
        }
        nav {
            display: flex;
            justify-content: center;
            background-color: #e0e0e0;
            padding: 10px;
        }
        nav button {
            background-color: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }
        nav button.active {
            border-bottom: 3px solid #e71721;
            font-weight: bold;
        }
        .container {
            padding: 20px;
            max-width: 900px;
            margin: auto;
        }
        .hidden {
            display: none;
        }
        .form-floating label.required::after {
            content: " *";
            color: red;
        }
        input:invalid {
            border-color: #dc3545;
        }
        .invalid-feedback {
            display: none;
            color: #dc3545;
        }
        input:invalid ~ .invalid-feedback {
            display: block;
        }
    </style>
</head>
<body>
<header>
    <img src="larSantaFilomena.png" alt="Logo Lar Santa Filomena">
    <h1>Gerenciar Fornecedores</h1>
</header>
<nav>
    <button id="abaCadastro" class="active" onclick="mostrarAba('cadastro')">Cadastro</button>
    <button id="abaLista" onclick="mostrarAba('lista')">Lista de Fornecedores</button>
</nav>
<div class="container">
    <div id="mensagem" class="mb-3"></div>

    <div id="cadastro">
        <form id="fornecedor-form" class="row g-3 needs-validation" novalidate>
            <input type="hidden" id="forn_cod">

            <div class="col-md-6 form-floating">
                <input type="text" class="form-control" id="forn_nome" placeholder="Nome" required>
                <label for="forn_nome" class="required">Nome</label>
                <div class="invalid-feedback">Nome é obrigatório.</div>
            </div>
            <div class="col-md-6 form-floating">
                <input type="text" class="form-control" id="forn_cnpj" placeholder="CNPJ" required pattern="\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}">
                <label for="forn_cnpj" class="required">CNPJ</label>
                <div class="invalid-feedback">Informe um CNPJ válido (00.000.000/0000-00).</div>
            </div>
            <div class="col-md-6 form-floating">
                <input type="text" class="form-control" id="forn_telefone" placeholder="Telefone" pattern="\(\d{2}\) \d{4,5}-\d{4}">
                <label for="forn_telefone">Telefone</label>
                <div class="invalid-feedback">Formato esperado: (00) 00000-0000.</div>
            </div>
            <div class="col-md-6 form-floating">
                <input type="text" class="form-control" id="forn_contato" placeholder="Contato">
                <label for="forn_contato">Contato</label>
            </div>
            <div class="col-md-6 form-floating">
                <input type="email" class="form-control" id="forn_email" placeholder="E-mail">
                <label for="forn_email">E-mail</label>
                <div class="invalid-feedback">Informe um e-mail válido.</div>
            </div>
            <div class="col-md-6 form-floating">
                <input type="text" class="form-control" id="forn_logradouro" placeholder="Logradouro">
                <label for="forn_logradouro">Logradouro</label>
            </div>
            <div class="col-md-2 form-floating">
                <input type="text" class="form-control" id="forn_numero" placeholder="Número">
                <label for="forn_numero">Número</label>
            </div>
            <div class="col-md-4 form-floating">
                <input type="text" class="form-control" id="forn_cidade" placeholder="Cidade" required>
                <label for="forn_cidade" class="required">Cidade</label>
                <div class="invalid-feedback">Cidade é obrigatória.</div>
            </div>
            <div class="col-md-3 form-floating">
                <input type="text" class="form-control" id="forn_cep" placeholder="CEP" pattern="\d{5}-\d{3}">
                <label for="forn_cep">CEP</label>
                <div class="invalid-feedback">Formato esperado: 00000-000.</div>
            </div>
            <div class="col-md-3 form-floating">
                <input type="text" class="form-control" id="forn_complemento" placeholder="Complemento">
                <label for="forn_complemento">Complemento</label>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Salvar</button>
                <button type="button" class="btn btn-secondary d-none" id="btnCancelar" onclick="limparFormulario()">Cancelar</button>
            </div>
        </form>
    </div>

    <div id="lista" class="hidden">
        <table class="table table-bordered">
            <thead class="table-dark">
            <tr>
                <th>Nome</th>
                <th>CNPJ</th>
                <th>Telefone</th>
                <th>Logradouro</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody id="fornecedores-list"></tbody>
        </table>
    </div>
</div>
<script>
    const apiBase = "http://localhost:8080/apis/fornecedor";

    function aplicarMascaraCNPJ(valor) {
        valor = valor.replace(/\D/g, "");
        valor = valor.replace(/(\d{2})(\d)/, "$1.$2");
        valor = valor.replace(/(\d{3})(\d)/, "$1.$2");
        valor = valor.replace(/(\d{3})(\d{1,4})/, "$1/$2");
        valor = valor.replace(/(\d{4})(\d{1,2})$/, "$1-$2");
        return valor;
    }

    function aplicarMascaraTelefone(valor) {
        valor = valor.replace(/\D/g, "");
        if (valor.length <= 10) {
            valor = valor.replace(/(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
        } else {
            valor = valor.replace(/(\d{2})(\d{5})(\d{0,4})/, "($1) $2-$3");
        }
        return valor;
    }

    function formatarCNPJ(cnpj) {
        return aplicarMascaraCNPJ(cnpj);
    }

    function formatarTelefone(telefone) {
        return aplicarMascaraTelefone(telefone);
    }

    document.getElementById("forn_cnpj").addEventListener("input", (e) => {
        e.target.value = aplicarMascaraCNPJ(e.target.value);
    });

    document.getElementById("forn_telefone").addEventListener("input", (e) => {
        e.target.value = aplicarMascaraTelefone(e.target.value);
    });


    function mostrarAba(aba) {
        document.getElementById("cadastro").classList.add("hidden");
        document.getElementById("lista").classList.add("hidden");
        document.getElementById("abaCadastro").classList.remove("active");
        document.getElementById("abaLista").classList.remove("active");
        document.getElementById(aba).classList.remove("hidden");
        document.getElementById("aba" + aba.charAt(0).toUpperCase() + aba.slice(1)).classList.add("active");
    }

    function preencherFormulario(f) {
        document.getElementById("forn_cod").value = f.id || f.forn_cod || "";
        document.getElementById("forn_nome").value = f.nome || f.forn_nome || "";
        document.getElementById("forn_cnpj").value = f.cnpj || f.forn_cnpj || "";
        document.getElementById("forn_telefone").value = f.telefone || f.forn_telefone || "";
        document.getElementById("forn_contato").value = f.contato || f.forn_contato || "";
        document.getElementById("forn_email").value = f.email || f.forn_email || "";
        document.getElementById("forn_logradouro").value = f.logradouro || f.forn_logradouro || "";
        document.getElementById("forn_numero").value = f.numero || f.forn_numero || "";
        document.getElementById("forn_cidade").value = f.cidade || f.forn_cidade || "";
        document.getElementById("forn_cep").value = f.cep || f.forn_cep || "";
        document.getElementById("forn_complemento").value = f.complemento || f.forn_complemento || "";
        document.getElementById("btnCancelar").classList.remove("d-none");
    }

    async function carregarFornecedores() {
        const res = await fetch(apiBase);
        const fornecedores = await res.json();
        const lista = document.getElementById("fornecedores-list");
        lista.innerHTML = "";
        fornecedores.forEach(f => {
            const nome = f.nome || f.forn_nome;
            const cnpj = formatarCNPJ(f.cnpj || f.forn_cnpj || "");
            const telefone = formatarTelefone(f.telefone || f.forn_telefone || "");
            const logradouro = f.logradouro || f.forn_logradouro || "";

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${nome}</td>
                <td>${cnpj}</td>
                <td>${telefone}</td>
                <td>${logradouro}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick='editar(${JSON.stringify(f)})'>Editar</button>
                    <button class="btn btn-danger btn-sm" onclick='deletar(${f.id || f.forn_cod})'>Excluir</button>
                </td>`;
            lista.appendChild(row);
        });
    }

    function editar(f) {
        mostrarAba("cadastro");
        preencherFormulario(f);
    }

    async function deletar(id) {
        if (!confirm("Deseja realmente excluir este fornecedor?")) return;
        try {
            const res = await fetch(`${apiBase}/${id}`, { method: "DELETE" });
            const json = await res.json();
            const msg = json.mensagem || json.erro || "Operação realizada";
            document.getElementById("mensagem").textContent = msg;
            document.getElementById("mensagem").className = res.ok ? "alert alert-success" : "alert alert-danger";
            if (res.ok) carregarFornecedores();
        } catch (err) {
            document.getElementById("mensagem").textContent = err.message;
            document.getElementById("mensagem").className = "alert alert-danger";
        }
    }

    function limparFormulario() {
        document.getElementById("fornecedor-form").reset();
        document.getElementById("forn_cod").value = "";
        document.getElementById("btnCancelar").classList.add("d-none");
    }

    document.addEventListener("DOMContentLoaded", () => {
        carregarFornecedores();
        document.getElementById("fornecedor-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add("was-validated");
                return;
            }

            const campos = ["forn_cod", "forn_nome", "forn_cnpj", "forn_telefone", "forn_contato", "forn_email", "forn_logradouro", "forn_numero", "forn_cidade", "forn_cep", "forn_complemento"];
            const dados = {};
            campos.forEach(id => {
                const el = document.getElementById(id);
                if (el) dados[id] = el.value || "";
            });

            const method = dados.forn_cod ? "PUT" : "POST";
            if (!dados.forn_cod) delete dados.forn_cod;
            console.log("Enviando:", dados, "method:", method);
            console.log("Dados serializados:", new URLSearchParams(dados).toString());

            try {
                const res = await fetch(apiBase, {
                    method,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams(dados).toString()
                });
                const json = await res.json();
                const msg = json.mensagem || json.erro || "Operação realizada";
                document.getElementById("mensagem").textContent = msg;
                document.getElementById("mensagem").className = res.ok ? "alert alert-success" : "alert alert-danger";

                if (res.ok) {
                    limparFormulario();
                    carregarFornecedores();
                    mostrarAba("lista");
                }
            } catch (err) {
                document.getElementById("mensagem").textContent = err.message;
                document.getElementById("mensagem").className = "alert alert-danger";
            }
        });
    });
</script>
</body>
</html>
